name: Desktop Build & Release

on:
  workflow_dispatch:  # Allow manual trigger
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  build-desktop:
    name: Build & Release Desktop App
    runs-on: windows-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write
      actions: read  # Required to download artifacts from other workflows
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Download the wheel package built in the CI workflow
      # This ensures the desktop app uses the same artreactor version
      - name: Download wheel package
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: ci.yml
          # Use specific run_id if triggered by workflow_run, otherwise get latest successful
          run_id: ${{ github.event.workflow_run.id || '' }}
          workflow_conclusion: ${{ github.event_name == 'workflow_dispatch' && 'success' || '' }}
          name: python-package-distributions
          path: dist/

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: |
            uv.lock
            pyproject.toml
            **/*.toml

      - name: Set up Python
        run: uv python install 3.12

      - name: Get version from pyproject.toml
        id: version
        shell: pwsh
        run: |
          $version = uv run python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])"
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: src/ArcVision/package-lock.json

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install artreactor from wheel
        shell: pwsh
        run: |
          $wheel = Get-ChildItem -Path dist -Filter "*.whl" | Select-Object -First 1
          if (-not $wheel) {
              Write-Error "No wheel file found in dist/"
              exit 1
          }
          Write-Host "Installing wheel: $($wheel.Name)"
          uv pip install $wheel.FullName
          uv sync --frozen --no-install-project

      - name: Build Desktop App
        shell: powershell
        run: .\scripts\build.ps1 -Version "${{ steps.version.outputs.version }}"
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_KEY_PASSWORD }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_run'
        with:
          files: |
            build/v*/*.msi
            build/v*/*.exe
          name: Desktop Release v${{ steps.version.outputs.version }}
          tag_name: desktop-v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
